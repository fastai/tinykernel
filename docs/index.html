---

title: tinykernel


keywords: fastai
sidebar: home_sidebar

summary: "A minimal Python kernel, so you can run Python in your Python."
description: "A minimal Python kernel, so you can run Python in your Python."
nb_path: "index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All the clever stuff in this library is provided by Python's builtin <code>ast</code> module and compilation/exec/eval system, along with <a href="https://ipython.org/">IPython</a>'s <code>CachingCompiler</code> which does some <a href="https://cprohm.de/article/better-test-output-with-ast-rewriting-and-a-patched-standard-library.html/">deep magic</a>. <code>tinykernel</code> just brings them together with a little glue.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With pip:</p>

<pre><code>pip install tinykernel

</code></pre>
<p>With conda:</p>

<pre><code>conda install -c fastai tinykernel</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use">How to use<a class="anchor-link" href="#How-to-use"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This library provides a single class, <code>TinyKernel</code>, which is a tiny persistent kernel for Python code:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="n">TinyKernel</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Call it, passing Python code, to have the code executed in a separate Python environment:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">k</span><span class="p">(</span><span class="s2">&quot;a=1&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Expressions return the value of the expression:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">k</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>1</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All variables are persisted across calls:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">k</span><span class="p">(</span><span class="s2">&quot;a+=1&quot;</span><span class="p">)</span>
<span class="n">k</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>2</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Multi-line inputs are supported. If the last line is an expression, it is returned:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">k</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;import types</span>
<span class="s2">b = types.SimpleNamespace(foo=a)</span>
<span class="s2">b&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>namespace(foo=2)</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The original source code is stored, so <code>inspect.getsource</code> works and, tracebacks have full details.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">k</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;def f(): pass # a comment</span>
<span class="s2">import inspect</span>
<span class="s2">inspect.getsource(f)&quot;&quot;&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;def f(): pass # a comment\n&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>When creating a <code>TinyKernel</code>, you can pass a dict of globals to initialize the environment:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="n">TinyKernel</span><span class="p">(</span><span class="n">glb</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span><span class="s1">&#39;bar&#39;</span><span class="p">})</span>
<span class="n">k</span><span class="p">(</span><span class="s1">&#39;foo*2&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;barbar&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Pass <code>name</code> to customize the string that appears in tracebacks ("kernel" by default):</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="n">TinyKernel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;myapp&#39;</span><span class="p">)</span>
<span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;def f():</span>
<span class="s1">    return 1/0</span>
<span class="s1">print(f())&#39;&#39;&#39;</span>
<span class="k">try</span><span class="p">:</span> <span class="n">k</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Traceback (most recent call last):
  File &#34;&lt;ipython-input-37-8b370e64c5cb&gt;&#34;, line 5, in &lt;module&gt;
    try: k(code)
  File &#34;/home/jhoward/git/tinykernel/tinykernel/__init__.py&#34;, line 20, in __call__
    if expr: return self._run(Expression(expr.value), nm, &#39;eval&#39;)
  File &#34;/home/jhoward/git/tinykernel/tinykernel/__init__.py&#34;, line 12, in _run
    def _run(self, p, nm, mode=&#39;exec&#39;): return eval(compiler(p, nm, mode), self.glb)
  File &#34;&lt;myapp--1-57331cf14e08&gt;&#34;, line 3, in &lt;module&gt;
    print(f())
  File &#34;&lt;myapp--1-57331cf14e08&gt;&#34;, line 2, in f
    return 1/0
ZeroDivisionError: division by zero

</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Acknowledgements">Acknowledgements<a class="anchor-link" href="#Acknowledgements"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Thanks to Christopher Prohm, Matthias Bussonnier, and Aaron Meurer for their helpful insights in <a href="https://twitter.com/jeremyphoward/status/1424990665746763781">this twitter thread</a>.</p>

</div>
</div>
</div>
</div>
 

